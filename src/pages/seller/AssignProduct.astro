---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getAllProducts } from '../../firebase/server';

const products = await getAllProducts(); // Obtener todos los productos desde el servidor
---

<BaseLayout>
  <section class="container mx-auto px-6 py-12">
    <h2 class="text-3xl font-bold mb-6">Asignar Precio y Stock a Producto Existente</h2>
    <div id="error-container" class="text-red-600 mb-4"></div>
    <div id="success-container" class="text-green-600 mb-4"></div>

    <form id="assignProductForm" class="space-y-4">
      <div>
        <label for="existingProduct" class="block text-sm font-medium text-gray-700">Selecciona Producto Existente</label>
        <select id="existingProduct" name="existingProduct" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
          <option value="">-- Selecciona un producto --</option>
          {products.map(product => (
            <option value={product.id}>
              {product.name} - {product.artistName}
            </option>
          ))}
        </select>
      </div>
      <div>
        <label for="price" class="block text-sm font-medium text-gray-700">Precio</label>
        <input type="number" id="price" name="price" min="0" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required />
      </div>
      <div>
        <label for="stock" class="block text-sm font-medium text-gray-700">Stock</label>
        <input type="number" id="stock" name="stock" min="0" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required />
      </div>
      <button type="submit" class="mt-4 bg-green-600 text-white px-4 py-2 rounded">Asignar Precio y Stock</button>
    </form>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('assignProductForm');
      const errorContainer = document.getElementById('error-container');
      const successContainer = document.getElementById('success-container');

      if (form) {
        form.addEventListener('submit', async (event) => {
          event.preventDefault();

          // Limpiar contenedores de mensajes
          if (errorContainer) errorContainer.textContent = '';
          if (successContainer) successContainer.textContent = '';

          // Obtener los valores del formulario de forma segura
          const existingProductElement = document.getElementById('existingProduct');
          const priceElement = document.getElementById('price');
          const stockElement = document.getElementById('stock');

          // Verificar que los elementos existen y son del tipo correcto
          if (
            existingProductElement instanceof HTMLSelectElement &&
            priceElement instanceof HTMLInputElement &&
            stockElement instanceof HTMLInputElement
          ) {
            const productId = existingProductElement.value;
            const price = parseFloat(priceElement.value);
            const stock = parseInt(stockElement.value, 10);

            // Validación básica
            if (!productId || isNaN(price) || isNaN(stock)) {
              if (errorContainer) errorContainer.textContent = 'Por favor, completa todos los campos correctamente.';
              return;
            }

            try {
              // Enviar la solicitud al servidor
              const response = await fetch('/api/seller/assign-product', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ productId, price, stock }),
              });

              let result;
              try {
                result = await response.json();
              } catch (jsonError) {
                console.error('Error al parsear JSON:', jsonError);
                throw new Error('Respuesta no es JSON');
              }

              if (response.ok) {
                if (successContainer) successContainer.textContent = result.message;
                existingProductElement.value = '';
                priceElement.value = '';
                stockElement.value = '';
              } else {
                if (errorContainer) errorContainer.textContent = result.message || 'Error al asignar el producto.';
              }
            } catch (error) {
              console.error('Error al asignar el producto:', error);
              if (errorContainer) errorContainer.textContent = 'Error al asignar el producto. Por favor, intenta nuevamente.';
            }
          } else {
            if (errorContainer) errorContainer.textContent = 'Error al obtener los valores del formulario.';
          }
        });
      }
    });
  </script>
</BaseLayout>
