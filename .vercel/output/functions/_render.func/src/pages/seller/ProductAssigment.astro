---
// Importar funciones necesarias
import { getProducts } from '../../firebase/server';

// Cargar productos desde Firestore
const products = await getProducts();

// Definimos los valores iniciales
let selectedProductId = '';
let price = '';
let stock = '';
let sellerName = '';

// Función para enviar el formulario
async function handleSubmit(event) {
  event.preventDefault();

  // Verificar que todos los campos estén llenos
  if (!selectedProductId || !price || !stock || !sellerName) {
    alert("Por favor completa todos los campos");
    return;
  }

  const sellerId = sellerName ? "generated-seller-id" : null; // Generar un id si el nombre está presente

  try {
    const response = await fetch('/api/auth/seller/assign-product', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        sellerId,
        sellerName,
        productId: selectedProductId,
        price: parseFloat(price),
        stock: parseInt(stock, 10),
      }),
    });

    if (response.ok) {
      alert('Producto asignado correctamente');

      // Limpiar campos después de guardar
      selectedProductId = '';
      price = '';
      stock = '';
      sellerName = '';
    } else {
      const errorData = await response.json();
      console.error('Error en la respuesta:', errorData);
      alert(`Error: ${errorData.message}`);
    }
  } catch (error) {
    console.error('Error al guardar el producto:', error); // Mensaje de error en consola
    alert(`Error: ${error.message}`);
  }
}
---

<section class="mx-auto max-w-4xl px-8 py-16">
  <h2 class="text-2xl font-bold text-gray-900 mb-8">Asignar Producto a Vendedor</h2>

  <!-- Formulario para asignar el producto al vendedor -->
  <form onsubmit="handleSubmit(event)" class="space-y-6">
    
    <!-- Selección de Producto -->
    <div>
      <label for="product" class="block text-sm font-medium text-gray-700">Selecciona un Producto</label>
      <select
        id="product"
        name="product"
        onchange="selectedProductId = this.value"
        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
      >
        <option value="">Selecciona un producto</option>
        {products.map((product) => (
          <option value={product.id}>{product.name}</option>
        ))}
      </select>
    </div>

    <!-- Campo para Nombre del Vendedor -->
    <div>
      <label for="seller-name" class="block text-sm font-medium text-gray-700">Nombre del Vendedor</label>
      <input
        type="text"
        id="seller-name"
        name="seller-name"
        onchange="sellerName = this.value"
        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
        required
      />
    </div>

    <!-- Campo para el Precio -->
    <div>
      <label for="price" class="block text-sm font-medium text-gray-700">Precio</label>
      <input
        type="number"
        id="price"
        name="price"
        onchange="price = this.value"
        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
        required
      />
    </div>

    <!-- Campo para el Stock -->
    <div>
      <label for="stock" class="block text-sm font-medium text-gray-700">Stock</label>
      <input
        type="number"
        id="stock"
        name="stock"
        onchange="stock = this.value"
        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
        required
      />
    </div>

    <!-- Botón de Enviar -->
    <div>
      <button
        type="submit"
        class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
      >
        Asignar Producto
      </button>
    </div>
  </form>
</section>
